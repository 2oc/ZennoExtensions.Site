<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Работа с менеджером аккаунтов &middot; ZennoExtensions
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="page">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        ZennoExtensions
      </a>
    </div>
    <p class="lead">Библиотека для <a href="http://zennolab.com/ru/products/zennoposter/" target="_blank">ZennoPoster</a></p>
  </header>
  
  <a class="page-link" href="http://zennolab.com/discussion/" target="_blank">Форум ZennoLab</a>

  <br/>

  <div class="lead">Статьи</div>
  <ul>
    <li>
      <a class="page-link "
         
         href="/start">Подключение</a>
    </li>
    <li>
      <a class="page-link  active"
        style="color: #00ccff"
        href="/AccountManager">Менеджер аккаунтов</a>
    </li>
    <li>
      <a class="page-link "
        
        href="/BrowserManager">Настройка браузера</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/MultiLogger">Логирование</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/ExtensionMethods">Методы расширения</a>
    </li>
  </ul>
  <a class="page-link "
     
     href="/docs">Документация</a>
  <ul>
    <li>
      <a class="page-link "
         
         href="/docs/#AccountManager">Менеджер аккаунтов</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/docs/#Browser">Настройка браузера</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/docs/#MultiLogger">Мультилогер</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/docs/#Instance">Instance</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/docs/#Project">Project</a>
    </li>
    <li>
      <a class="page-link "
         
      href="/docs/#Variables">Project.Variables</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/docs/#Tab">Tab</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/docs/#HtmlElement">HtmlElement</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/docs/#DateTime">DateTime</a>
    </li>
    <li>
      <a class="page-link "
         
         href="/docs/#Int32">Int32</a>
    </li>
  </ul>

</div>

    <main class="container">
      <header>
  <h1 class="page-title">Работа с менеджером аккаунтов</h1>
</header>
<div class="content">
  <p>Менеджер аккаунтов предоставляет функционал многопоточной работы со списком аккаунтов.</p>

<hr />

<p>Функционал менеджера аккаунтов находится в пространстве имен <code class="highlighter-rouge">ZennoExtensions.AccountManager</code>.<br />
Для использования подключите пространство имен:</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">ZennoExtensions.AccountManager</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<h2 id="инициализация">Инициализация</h2>

<p>Чтобы приступить к работе с менеджером аккаунтов нужно обратиться к статическому методу <code class="highlighter-rouge">AccountManager.GetInstance()</code>, который вернет единственный для всех потоков экземпляр менеджера.</p>

<p>Затем нужно инициализировать экземпляр менеджера вызвав метод <code class="highlighter-rouge">Initialize</code> и указав путь к файлу с аккаунтами и путь до файла конфигурации аккаунтов.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="n">accountsPath</span> <span class="p">=</span> <span class="s">@"C:\accounts.txt"</span><span class="p">;</span>
<span class="kt">string</span> <span class="n">configPath</span> <span class="p">=</span> <span class="n">accountsPath</span> <span class="p">+</span> <span class="s">".config.xml"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">manager</span> <span class="p">=</span> <span class="n">AccountManager</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">();</span>
<span class="n">manager</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="n">accountsPath</span><span class="p">,</span> <span class="n">configPath</span><span class="p">);</span>
</code></pre></div></div>

<p>Файл конфигурации представляет из себя Xml-файл, который генерируется на основе списка аккаунтов.
Конфигурация содержит данные, которые закрепляются за аккаунтами, например, прокси, а также набор свойств, благодаря которым потоки могут брать незанятые и незабаненные аккаунты .</p>

<h4 id="пример-конфигурации">Пример конфигурации:</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;Accounts</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Account</span> <span class="na">Id=</span><span class="s">"1"</span> <span class="na">Login=</span><span class="s">"user1"</span> <span class="na">Password=</span><span class="s">"pass"</span> <span class="na">Order=</span><span class="s">"135"</span> <span class="na">IsBusy=</span><span class="s">"false"</span> <span class="na">IsBanned=</span><span class="s">"false"</span> <span class="na">LastExecution=</span><span class="s">"16-11-2017 10:35:38"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Account</span> <span class="na">Id=</span><span class="s">"3"</span> <span class="na">Login=</span><span class="s">"user3"</span> <span class="na">Password=</span><span class="s">"pass"</span> <span class="na">Order=</span><span class="s">"131"</span> <span class="na">IsBusy=</span><span class="s">"false"</span> <span class="na">IsBanned=</span><span class="s">"false"</span> <span class="na">LastExecution=</span><span class="s">"16-11-2017 10:35:37"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Account</span> <span class="na">Id=</span><span class="s">"7"</span> <span class="na">Login=</span><span class="s">"user2"</span> <span class="na">Password=</span><span class="s">"pass"</span> <span class="na">Order=</span><span class="s">"132"</span> <span class="na">IsBusy=</span><span class="s">"false"</span> <span class="na">IsBanned=</span><span class="s">"false"</span> <span class="na">LastExecution=</span><span class="s">"16-11-2017 10:35:38"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Accounts&gt;</span>
</code></pre></div></div>

<ul>
  <li>Свойство <code class="highlighter-rouge">Order</code> показывает приоритет аккаунта для работы. Чем меньше его номер, тем скорее он вступит в работу. После того, как аккаунт закончит работу ему присваивается максимальный <code class="highlighter-rouge">Order</code> среди существующих аккаунтов. Таким образом работа между всеми аккаунтами распределяется равномерно, даже если пользователь добавил новые аккаунты в файл во время выполнения шаблона.</li>
  <li>Свойство <code class="highlighter-rouge">IsBusy</code> показывает находится ли данный аккаунт сейчас в работе.</li>
  <li>Свойство <code class="highlighter-rouge">IsBanned</code> показывает можно ли вообще брать данный аккаунт для работы. Вы можете устанавливать это свойство из кода или же пользователь может редактировать конфигурацию.</li>
  <li>Свойство <code class="highlighter-rouge">LastExecution</code> показывает когда в последний раз данный аккаунт находился в работе.</li>
</ul>

<hr />

<h2 id="получение-аккаунтов">Получение аккаунтов</h2>

<p>После того как инициализация менеджера аккаунтов произведена можно вызывать методы, которые возвращают аккаунты:</p>

<ul>
  <li><code class="highlighter-rouge">GetFreeAccountWithMinExecutionsCount(bool throwExceptionIfNoFreeAccounts = false)</code> — возвращает свободный и незабаненный аккаунт с минимальным количеством запусков, т.е. с минимальным значением свойства <code class="highlighter-rouge">Order</code>. Если свободных аккаунтов нет, то вернется <code class="highlighter-rouge">null</code>. В параметры метода можно передать <code class="highlighter-rouge">true</code>, тогда в случае отсутствия свободных аккаунтов будет генерироваться исключение.
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">var</span> <span class="n">account</span> <span class="p">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">GetFreeAccountWithMinExecutionsCount</span><span class="p">();</span>
    
  <span class="k">if</span> <span class="p">(</span><span class="n">account</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
      <span class="n">project</span><span class="p">.</span><span class="nf">SendInfoToLog</span><span class="p">(</span><span class="s">"Все аккаунты заняты"</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> 
    
  <span class="n">project</span><span class="p">.</span><span class="nf">SendInfoToLog</span><span class="p">(</span><span class="s">"Логин: "</span> <span class="p">+</span> <span class="n">account</span><span class="p">.</span><span class="n">Login</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> 
  <span class="n">project</span><span class="p">.</span><span class="nf">SendInfoToLog</span><span class="p">(</span><span class="s">"Пароль: "</span> <span class="p">+</span> <span class="n">account</span><span class="p">.</span><span class="n">Password</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> 
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">GetAccount(Predicate&lt;Account&gt; predicate)</code> — возвращает аккаунт, удовлетворяющий предикату.<br />
Например, можно получить свободный и незабаненный аккаунт, который не был в работе более 12-и часов:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">var</span> <span class="n">account</span> <span class="p">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">GetAccount</span><span class="p">(</span>
      <span class="n">account</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">account</span><span class="p">.</span><span class="n">IsBusy</span> 
              <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">account</span><span class="p">.</span><span class="n">IsBanned</span> 
              <span class="p">&amp;&amp;</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span> <span class="p">-</span> <span class="n">account</span><span class="p">.</span><span class="n">LastExecution</span> <span class="p">&gt;</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromHours</span><span class="p">(</span><span class="m">12</span><span class="p">));</span> 
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="освобождение-аккаунтов">Освобождение аккаунтов</h2>

<p>Методы получения аккаунтов помечают найденный аккаунт как занятый <code class="highlighter-rouge">account.IsBusy = true</code>, чтобы другие потоки не могли взять данный аккаунт.
Поэтому после окончания работы с аккаунтом нужно освободить его для других потоков.</p>

<p>Для этого нужно вызвать метод <code class="highlighter-rouge">Release</code> на объекте аккаунта:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">account</span> <span class="p">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">GetFreeAccountWithMinExecutionsCount</span><span class="p">();</span> 
<span class="k">if</span><span class="p">(</span><span class="n">account</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Какая-то работа с аккаунтом</span>
    <span class="c1">// ...</span>
    
    <span class="c1">// Освобождаем аккаунт</span>
    <span class="n">account</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Метод <code class="highlighter-rouge">Release</code> устанавливает свойство <code class="highlighter-rouge">IsBusy = false</code>, обновляет дату последнего запуска аккаунта и обновляет конфигурацию аккаунтов. Таким образом все внесенные изменения для аккаунта сохраняются и все потоки работают с актуальными данными.</p>

<p>Может случиться внештатная ситуация, например когда ZennoPoster вылетит, и тогда есть вероятность, что аккаунт не успеет разблокироваться и в конфигурации так и останется заблокированным для других потоков.</p>

<p>Чтобы избежать подобной ситуации рекомендуется после инициализации менеджера вызывать метод <code class="highlighter-rouge">ReleaseAccounts(Predicate&lt;Account&gt; predicate)</code>, который освобождает все аккаунты, удовлетворяющие предикату.</p>

<p>Пример, в котором освобождаются все аккаунты простаивающие более одно часа:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="n">accountsPath</span> <span class="p">=</span> <span class="s">@"C:\accounts.txt"</span><span class="p">;</span>
<span class="kt">string</span> <span class="n">configPath</span> <span class="p">=</span> <span class="n">accountsPath</span> <span class="p">+</span> <span class="s">".config.xml"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">manager</span> <span class="p">=</span> <span class="n">AccountManager</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">();</span>
<span class="n">manager</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="n">accountsPath</span><span class="p">,</span> <span class="n">configPath</span><span class="p">);</span>
<span class="n">manager</span><span class="p">.</span><span class="nf">ReleaseAccounts</span><span class="p">(</span><span class="n">account</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">account</span><span class="p">.</span><span class="n">IsBusy</span>                                                   
                                   <span class="p">&amp;&amp;</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span> <span class="p">-</span> <span class="n">account</span><span class="p">.</span><span class="n">LastExecution</span> <span class="p">&gt;</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromHours</span><span class="p">(</span><span class="m">1</span><span class="p">));</span> 
</code></pre></div></div>

<hr />

<h2 id="закрепление-данных-за-аккаунтом">Закрепление данных за аккаунтом</h2>

<p>Чтобы закрепить прокси за аккаунтом достаточно указать экземпляр прокси и после того, как конфигурация будет сохранена после вызова метода <code class="highlighter-rouge">account.Release()</code> (или <code class="highlighter-rouge">account.SaveChanges()</code>, который обновляет данные аккаунта в конфигурации) в файле аккаунта за аккаунтом закрепятся новые данные.</p>

<p>Пример:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">freeAccount</span> <span class="p">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">GetFreeAccountWithMinExecutionsCount</span><span class="p">();</span>
<span class="n">freeAccount</span><span class="p">.</span><span class="n">Proxy</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Proxy</span>
<span class="p">{</span>
    <span class="n">Ip</span> <span class="p">=</span> <span class="s">"127.0.0.1"</span><span class="p">,</span>
    <span class="n">Port</span> <span class="p">=</span> <span class="m">80</span><span class="p">,</span>
    <span class="n">Scheme</span> <span class="p">=</span> <span class="s">"socks5"</span>
<span class="p">};</span> 

<span class="n">freeAccount</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span> <span class="c1">// Сохраняем изменения в аккаунте.</span>
</code></pre></div></div>

<p>После выполнения этого кода за аккаунтом закрепится прокси:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Account</span> <span class="na">Id=</span><span class="s">"3"</span> <span class="na">Login=</span><span class="s">"user3"</span> <span class="na">Password=</span><span class="s">"password"</span>
         <span class="na">Order=</span><span class="s">"136"</span> <span class="na">IsBusy=</span><span class="s">"false"</span> <span class="na">IsBanned=</span><span class="s">"false"</span> <span class="na">LastExecution=</span><span class="s">"28-11-2017 15:33:48"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Proxy</span> <span class="na">Ip=</span><span class="s">"127.0.0.1"</span> <span class="na">Port=</span><span class="s">"80"</span> <span class="na">Scheme=</span><span class="s">"socks5"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Account&gt;</span>
</code></pre></div></div>

<p>Таким образом вы можете закреплять за аккаунтами и свои данные. Достаточно добавить новые свойства, которые будут представлять ваши данные,  в клаcc <code class="highlighter-rouge">Account</code>.</p>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
